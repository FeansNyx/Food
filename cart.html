<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Keranjang - ILCE Coffee</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background-color: #fffdf8;
    }

    header {
      background-color: #6b4f3b;
      color: white;
      padding: 1rem 2rem;
      text-align: center;
    }

    .container {
      padding: 2rem;
    }

    .cart-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      background: #fff;
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .cart-item img {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
    }

    .cart-details {
      flex: 1;
    }

    .cart-details h3 {
      margin: 0 0 0.3rem;
    }

    .cart-details p {
      margin: 0;
      font-size: 0.9rem;
      color: #666;
    }

    .cart-details span {
      display: block;
      margin-top: 0.5rem;
      font-weight: bold;
    }

    .quantity-control {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 0.5rem;
    }

    .quantity-box {
      display: flex;
      align-items: center;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 4px 10px;
      background-color: #f9f9f9;
      font-weight: bold;
    }

    .quantity-button {
      background-color: #eee;
      border: none;
      padding: 5px 10px;
      font-size: 1.1rem;
      cursor: pointer;
      border-radius: 4px;
    }

    .remove-button {
      background-color: crimson;
      color: white;
      border: none;
      padding: 0.5rem 0.8rem;
      border-radius: 6px;
      cursor: pointer;
    }

    .total, .diskon-info {
      text-align: right;
      font-size: 1.2rem;
      font-weight: bold;
      margin-top: 1rem;
      color: #333;
    }

    .diskon-info {
      color: green;
    }

    .form-group {
      margin-top: 2rem;
    }

    .form-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .form-group textarea,
    .form-group input {
      width: 100%;
      padding: 0.8rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }

    .submit-button {
      display: block;
      margin-top: 0.8rem;
      padding: 0.7rem 1.5rem;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
    }

    .submit-button:hover {
      background-color: #45a049;
    }

    .back-button {
      display: block;
      margin: 2rem auto 0;
      padding: 0.7rem 1.5rem;
      background-color: #6b4f3b;
      color: white;
      text-align: center;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      width: fit-content;
    }

    .empty-message {
      text-align: center;
      font-size: 1.2rem;
      color: #888;
      margin-top: 4rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>Keranjang Anda</h1>
  </header>

  <div class="container" id="cart-container"></div>

  <script>
    function formatRupiah(angka) {
      return "Rp" + angka.toLocaleString("id-ID");
    }

    function loadCart() {
      const cartContainer = document.getElementById("cart-container");
      let cart = JSON.parse(localStorage.getItem("cart")) || [];
      const diskonPersen = parseInt(localStorage.getItem("diskon") || "0");

      cartContainer.innerHTML = "";

      if (cart.length === 0) {
        cartContainer.innerHTML = `<div class="empty-message">Keranjang kosong</div>
                                   <a href="menu.html" class="back-button">Kembali ke Menu</a>`;
        return;
      }

      let total = 0;

      cart.forEach((item, index) => {
        if (!item.qty) item.qty = 1;
        const hargaAngka = parseInt(item.price.replace(/\D/g, ""));
        total += hargaAngka * item.qty;

        const itemElement = document.createElement("div");
        itemElement.className = "cart-item";

        itemElement.innerHTML = `
          <img src="${item.img}" alt="${item.name}">
          <div class="cart-details">
            <h3>${item.name}</h3>
            <p>${item.description}</p>
            <span>${item.price}</span>
            <div class="quantity-control">
              <button class="quantity-button" onclick="changeQty(${index}, -1)">−</button>
              <div class="quantity-box">${item.qty}x</div>
              <button class="quantity-button" onclick="changeQty(${index}, 1)">+</button>
            </div>
          </div>
          <button class="remove-button" onclick="removeItem(${index})">❌</button>
        `;

        cartContainer.appendChild(itemElement);
      });

      if (diskonPersen > 0) {
        const potongan = Math.round((diskonPersen / 100) * total);
        const diskonElem = document.createElement("div");
        diskonElem.className = "diskon-info";
        diskonElem.textContent = `- ${diskonPersen}%: -${formatRupiah(potongan)}`;
        cartContainer.appendChild(diskonElem);
        total -= potongan;
      }

      const totalElement = document.createElement("div");
      totalElement.className = "total";
      totalElement.textContent = "Total: " + formatRupiah(total);
      cartContainer.appendChild(totalElement);

      const diskonBox = document.createElement("div");
      diskonBox.className = "form-group";
      diskonBox.innerHTML = `
        <label for="kode-diskon">Kode Diskon:</label>
        <input type="text" id="kode-diskon" placeholder="Masukkan kode diskon...">
        <div style="display: flex; gap: 10px; margin-top: 0.5rem;">
          <button class="submit-button" onclick="pakaiDiskon()">Gunakan</button>
          <button class="submit-button" style="background-color: crimson;" onclick="batalDiskon()">Batal</button>
        </div>
        <div id="diskon-info" style="margin-top: 0.5rem;"></div>
      `;
      cartContainer.appendChild(diskonBox);

      const alamatForm = document.createElement("div");
      alamatForm.className = "form-group";
      alamatForm.innerHTML = `
        <label for="alamat">Alamat Tujuan:</label>
        <textarea id="alamat" rows="3" placeholder="Masukkan alamat pengiriman..."></textarea>
        <button class="submit-button" onclick="buatPesanan()">Buat Pesanan</button>
      `;
      cartContainer.appendChild(alamatForm);

      const backButton = document.createElement("a");
      backButton.href = "menu.html";
      backButton.className = "back-button";
      backButton.textContent = "Kembali ke Menu";
      cartContainer.appendChild(backButton);

      localStorage.setItem("cart", JSON.stringify(cart));
    }

    function changeQty(index, delta) {
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      if (!cart[index].qty) cart[index].qty = 1;
      cart[index].qty += delta;
      if (cart[index].qty < 1) cart[index].qty = 1;
      localStorage.setItem("cart", JSON.stringify(cart));
      loadCart();
    }

    function removeItem(index) {
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      cart.splice(index, 1);
      localStorage.setItem("cart", JSON.stringify(cart));
      loadCart();
    }

    function buatPesanan() {
      const alamat = document.getElementById("alamat").value.trim();
      if (alamat === "") {
        alert("Mohon isi alamat tujuan terlebih dahulu.");
        return;
      }

      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      if (cart.length === 0) {
        alert("Keranjang kosong.");
        return;
      }

      const diskon = localStorage.getItem("diskon") || "0";

      // Ambil user yang sedang login
	  const user = JSON.parse(localStorage.getItem('loggedInUser'));
	  if (!user) {
	    alert("Anda harus login terlebih dahulu!");
	    return;
	  }

	  // Buat objek pesanan baru
	  const pesananBaru = {
	    userHP: user.no_hp,
	    cart,
	    alamat,
	    diskon,
	    tanggal: new Date().toLocaleString()
	  };
	
	  // Simpan ke array semua pesanan
	  let semuaPesanan = JSON.parse(localStorage.getItem("pesanan")) || [];
	  semuaPesanan.push(pesananBaru);
	  localStorage.setItem("pesanan", JSON.stringify(semuaPesanan));
	
	  // Bersihkan keranjang setelah pemesanan
	  localStorage.removeItem("cart");
	  localStorage.removeItem("diskon");

      window.location.href = "pesanan.html";
    }

    function pakaiDiskon() {
      const kode = document.getElementById("kode-diskon").value.trim().toUpperCase();
      const diskonInfo = document.getElementById("diskon-info");

      if (kode === "UM") {
        localStorage.setItem("diskon", "10");
        diskonInfo.textContent = "Diskon UM berhasil diterapkan.";
        diskonInfo.style.color = "green";
      } else {
        localStorage.removeItem("diskon");
        diskonInfo.textContent = "Kode tidak valid.";
        diskonInfo.style.color = "crimson";
      }

      loadCart();
    }

    function batalDiskon() {
      localStorage.removeItem("diskon");
      document.getElementById("diskon-info").textContent = "Diskon dibatalkan.";
      document.getElementById("diskon-info").style.color = "crimson";
      loadCart();
    }

    loadCart();
  </script>
</body>
</html>


